.. metadata-placeholder

   :authors: - frdbr (https://userbase.kde.org/User:frdbr)
             - Bernd Jordan (https://discuss.kde.org/u/berndmj)n

   :license: Creative Commons License SA 4.0

.. |OpenCV| raw:: html

   <a href="https://opencv.org/about/" target="_blank">OpenCV (Open Source Computer Vision Library)</a>

.. |DaSiamRPN| raw:: html

   <a href="https://arxiv.org/pdf/1808.06048.pdf" target="_blank">DaSiamRPN</a>

.. |more_info| raw:: html

   <a href="https://invent.kde.org/multimedia/kdenlive/-/blob/master/dev-docs/build.md#building-opencv-tracking-module" target="_blank">more info</a>


.. _effects-motion_tracker:

Motion Tracker
==============
.. versionadded:: 19.04.0

Motion tracking is the process of locating a moving object across time. Kdenlive uses |OpenCV|\ [1]_ for motion detection. The results of this effect can be used in other effects by copying the keyframe data generated by the Motion Tracker as position keyframes in the Transform effect, for example.

.. figure:: /images/effects_and_compositions/kdenlive2304_effects-motion_tracker.webp
   :width: 400px
   :alt: kdenlive2304_effects-motion_tracker

   Motion Tracker effect panel

..

How to track a region of a video? 
---------------------------------

The basic workflow for tracking a region is:

.. figure:: /images/effects_and_compositions/kdenlive_effects-motion_tracking_face.webp
   :align: left
   :width: 400px
   :alt: kdenlive_effects-motion_tracking_face

   Tracking the face of the model

* Apply the effect to a clip
* Select the desired region\ [2]_ to track on the Project Monitor
* Choose a tracking algorithm
* Click on the :guilabel:`Analyse` button

.. container:: clear-both

   .. figure:: /images/effects_and_compositions/kdenlive2304_effects-motion_tracker_copy_kf.webp
      :align: left
      :width: 90%
      :alt: kdenlive2304_effects-motion_tracker_copy_kf

      Options menu

   * When the analysis is done you can export the keyframes to the clipboard by clicking on |application-menu| and choose :guilabel:`Copy all keyframes to clipboard`. See also :ref:`Exchanging keyframes <effects-exchange_keyframes>`.

.. rst-class:: clear-both


Tracking algorithms
-------------------

KCF
^^^

**Kernelized Correlation Filters**

**Pros:** Accuracy and speed are both better than MIL and it reports tracking failure better than MIL.

**Cons:** Does not recover from full occlusion. 


CSRT
^^^^

In the Discriminative Correlation Filter with Channel and Spatial Reliability (DCF-CSR), we use the spatial reliability map for adjusting the filter support to the part of the selected region from the frame for tracking. This ensures enlarging and localization of the selected region and improved tracking of the non-rectangular regions or objects. It uses only 2 standard features (HoGs and Colornames). It also operates at a comparatively lower fps (25 fps) but gives higher accuracy for object tracking.


MOSSE
^^^^^

**Minimum Output Sum of Squared Error**

MOSSE uses an adaptive correlation for object tracking which produces stable correlation filters when initialized using a single frame. MOSSE tracker is robust to variations in lighting, scale, pose, and non-rigid deformations. It also detects occlusion based upon the peak-to-sidelobe ratio, which enables the tracker to pause and resume where it left off when the object reappears. MOSSE tracker also operates at a higher fps (450 fps and even more).

**Pros:** It is as accurate as other complex trackers and much faster.

**Cons:** On a performance scale, it lags behind the deep learning based trackers.


MIL
^^^

**Pros:** The performance is pretty good. It does a reasonable job under partial occlusion.

**Cons:** Tracking failure is not reported reliably. Does not recover from full occlusion.


MedianFlow
^^^^^^^^^^

**Pros:** Excellent tracking failure reporting. Works very well when the motion is predictable and there is no occlusion.

**Cons:** Fails under large motion.


DaSiam
^^^^^^

The |DaSiamRPN| visual tracking algorithm relies on deep-learning models to provide extremely accurate results.

In order to use the DaSiam algorithm you need to download the AI models

   1. :download:`https://files.kde.org/kdenlive/motion-tracker/DaSiamRPN/dasiamrpn_kernel_cls1.onnx`
   2. :download:`https://files.kde.org/kdenlive/motion-tracker/DaSiamRPN/dasiamrpn_kernel_r1.onnx`
   3. :download:`https://files.kde.org/kdenlive/motion-tracker/DaSiamRPN/dasiamrpn_model.onnx`

and place them in: :ref:`folders_for_models`


Nano
^^^^

.. versionadded:: 23.08

Nano tracker is a lightweight model and gives good results and is fast.

In order to use the Nano algorithm you need to download the AI models (model size about 1.9 MB)

  1. :download:`https://files.kde.org/kdenlive/motion-tracker/Nano/nanotrack_backbone_sim.onnx`
  2. :download:`https://files.kde.org/kdenlive/motion-tracker/Nano/nanotrack_head_sim.onnx`

and place them in: :ref:`folders_for_models`


.. _folders_for_models:

Folder for models
^^^^^^^^^^^^^^^^^

   **Linux**

   :file:`$HOME/.local/share/kdenlive/opencvmodels`

   Flatpak

   :file:`$HOME/.var/app/org.kde.kdenlive/data/kdenlive/opencvmodels`

   **Windows**

   :file:`%AppData%/kdenlive/opencvmodels`

   Press :kbd:`Win+R` (:kbd:`Windows` key and :kbd:`R` key simultaneously) and copy **%AppData%/kdenlive/**. Then create the folder `opencvmodels`


Frame shape
-----------

Select from Rectangle (default), Ellipse or Arrow. Choosing the right shape can make the tracking better.


Shape color
-----------

Select a color that makes the shape easier to see in the Project Monitor. Has no effect on the tracking.


Blur type
---------

.. figure:: /images/effects_and_compositions/kdenlive_effects-motion_tracker_blur_type.gif
   :width: 90%
   :alt: kdenlive_effects-motion_tracker_blur_type

   Different blur types in action

Four blur types are available: Median blur, Gaussian blur, Pixelate, Opaque fill


**Notes**

.. [1] If you want to build Kdenlive yourself you need to build MLT with OpenCV support. See here for |more_info|.

.. [2] If you see just a red rectangle in the Project Monitor but cannot move or size it enable Edit Mode by clicking on the |edit-mode| icon in the Project Monitor toolbar
